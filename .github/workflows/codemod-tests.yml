name: Codemod Cross-Platform Tests

on:
  push:
    paths:
      - 'userland-migrations/**'
  pull_request:
    paths:
      - 'userland-migrations/**'

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node: [18.x]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Prepare tmp (Unix)
        if: runner.os != 'Windows'
        run: |
          rm -rf tmp || true
          mkdir -p tmp
          cp -R userland-migrations/recipes/tls-securepair-to-tlssocket/tests/input/* tmp/
        shell: bash

      - name: Prepare tmp (Windows)
        if: runner.os == 'Windows'
        run: |
          Remove-Item -Recurse -Force tmp -ErrorAction SilentlyContinue
          New-Item -ItemType Directory tmp | Out-Null
          Copy-Item -Path userland-migrations\recipes\tls-securepair-to-tlssocket\tests\input\* -Destination tmp -Recurse -Force
        shell: powershell

      - name: Run codemod (Unix)
        if: runner.os != 'Windows'
        run: |
          npx codemod jssg run --language typescript userland-migrations/recipes/tls-securepair-to-tlssocket/src/workflow.ts --target tmp --allow-fs --no-interactive
        shell: bash

      - name: Run codemod (Windows)
        if: runner.os == 'Windows'
        run: |
          npx codemod jssg run --language typescript userland-migrations\recipes\tls-securepair-to-tlssocket\src\workflow.ts --target tmp --allow-fs --no-interactive
        shell: powershell

      - name: Diff outputs (Unix)
        if: runner.os != 'Windows'
        run: |
          git --no-pager diff --no-index -- tmp userland-migrations/recipes/tls-securepair-to-tlssocket/tests/expected || (echo "Diff found" && exit 1)
        shell: bash

      - name: Diff outputs (Windows)
        if: runner.os == 'Windows'
        run: |
          git --no-pager diff --no-index -- tmp userland-migrations\recipes\tls-securepair-to-tlssocket\tests\expected
          if ($LASTEXITCODE -ne 0) { exit 1 }
        shell: powershell
